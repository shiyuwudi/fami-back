<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
    <script src="/lib/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <title>Welcome to Fami-Campaign-Page</title>
    <noscript>Please enable javascript first!</noscript>
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
</head>
<body>
<div id="app">
    <div class="content" v-if="prod">
        <div class="desc">Please scan the QR code below</div>
        <div v-show="qr_code" id="qrcode"></div>
        <p v-show="code">{{ code }}</p>
        <p v-show="!code || !qr_code">Loading coupon info...</p>
        <div class="divide-con">
            <div class="divide"></div>
        </div>
        <div class="rules">
            <div class="rules-title">規則と詳細：</div>
            <ol class="rules-content">
                <li v-for="rule in rules">規則規則規則規則規則規則規則規則規則規則規則規則{{rule}}</li>
            </ol>
        </div>
    </div>
    <div class="other-access" v-else>
        Please open this link in ChargeSPOT App!
    </div>
</div>
<style>
    html,body {
        width: 100%;
        height: 100%;
        padding: 0;
        margin: 0;
    }
    #app {
        display: flex;
        flex-direction: column;
        align-items: center;
        background: rgb(107, 231, 230);
        margin: 0;
        padding: 0;
        overflow-y: auto;
    }
    .rules {
        display: flex;
        flex-direction: column;
        padding: 20px;
        align-self: flex-start;
    }
    .desc {
        color: darkgray;
        margin: 15px 0;
    }
    .content {
        background: white;
        width: 90%;
        margin: 5% 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        border-radius: 5px;
        box-shadow: rgba(0,0,0,.2)  0 1px 5px 0;
    }
    .rules .rules-title {
        font-size: small;
    }
    .rules .rules-content {
        font-size: smaller;
        color: darkgray;
    }
    .divide-con {
        width: calc(100% - 40px)
    }
    .divide {
        width: 100%;
        border-top:1px dashed #cccccc;height: 1px;overflow:hidden;
    }
</style>
<script>
    var app =
        new Vue({
            el: '#app',
            data: {
                qr_code: '',
                code: '',
                resp: '',
                rules: Array(20).fill(0).map((_, i) => i + 1),
                prod: false,
            },
            mounted() {
                this.getCode();
            },
            methods: {
                getCode: async function () {
                    this.resp = 'getCode';
                    const qs = this.getQueryString();
                    if (qs && qs.couponid) {
                        this.prod = true;
                        const resp = await axios({
                            method: 'post',
                            url: '/qr',
                            data: qs,
                        });
                        const {
                            code,
                            qr_code,
                        } = resp.data.data;
                        this.code = code;
                        this.qr_code = qr_code;
                        this.genQR();
                    }
                },
                genQR () {
                    new QRCode(document.getElementById("qrcode"), this.qr_code);
                },
                getQueryString() {
                    const url = location.search;
                    const theRequest = {};
                    if (url.indexOf("?") !== -1) {
                        let str = url.substr(1);
                        let strs = str.split("&");
                        for (let i = 0; i < strs.length; i++) {
                            theRequest[strs[i].split("=")[0]] = unescape(strs[i].split("=")[1]);
                        }
                    }
                    return theRequest;
                }
            },
        })
</script>
</body>
</html>
